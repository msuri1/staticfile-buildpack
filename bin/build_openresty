#!/bin/bash
# http://openresty.org/#Installation
# https://github.com/cloudfoundry-community/nginx-buildpack#building-the-nginx-package
# Dockerize Build when possible 

set -e #halt on any error

pcre_version=10.22
openresty_version=1.11.2.2
sudo apt-get update
sudo apt-get install -fy \
  build-essential \
  zlib1g-dev \
  libreadline-dev \
  libncurses5-dev \
  libpcre3-dev \
  libssl-dev \
  perl \
  make \
  wget


src=~/src
build=/app/openresty
target=/output

sudo rm -rf $build $src && sudo mkdir -p $build
mkdir -p $src
pushd $src

  wget "http://downloads.sourceforge.net/project/pcre/pcre2/$pcre_version/pcre2-$pcre_version.tar.gz" -v -O $src/pcre.tar
  tar -xzvf $src/pcre.tar
  pushd pcre2-$pcre_version/
    ./configure --prefix=$build
    make
    sudo make install
    sudo ldconfig # this is important otherwise nginx will compile but fail to load
  popd

  wget http://openresty.org/download/openresty-$openresty_version.tar.gz
  tar -xvzf openresty-$openresty_version.tar.gz

  pushd openresty-$openresty_version
    ./configure --prefix=$build  --with-pcre=$src/pcre2-$pcre_version --with-http_ssl_module --with-http_gzip_static_module --with-http_stub_status_module
    make
    sudo make install
  popd
popd

# Remove extras (help, utilities etc)
sudo rm -rf $build/bin
sudo rm -rf $build/sbin/nginx.old
sudo rm -rf $build/share/man

# PCRE license is in $build/share/doc/pcre/LICENCE
# Put Nginx license is in $build/share/doc/nginx
sudo mkdir -p $build/share/doc/nginx
sudo cp $src/openresty-$openresty_version/README.markdown $build/share/doc/nginx

cd /tmp/
wget https://raw.githubusercontent.com/bungle/lua-resty-session/master/lib/resty/session.lua --no-check-certificate
# Add lua-resty-session for session management
sudo mv /tmp/session.lua $build/lualib/resty

# Archive it all up
mkdir -p $target
cd /app
tar -zcvpf $target/openresty-$openresty_version.tar.gz openresty
md5sum $target/openresty-$openresty_version.tar.gz
